<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Campanhas - Flowbiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  </head>
  <body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Navbar -->
    <div id="navbar-container"></div>

    <!-- Conteúdo -->
    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
              <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
              </svg>
              Campanhas
            </h1>
            <p class="mt-2 text-gray-600">Gerencie suas campanhas de e-mail marketing</p>
          </div>
          <div class="flex items-center space-x-4">
            <div id="total-counter" class="bg-white rounded-lg shadow-sm px-6 py-4 border border-gray-200">
              <p class="text-sm text-gray-500 font-medium">Total de Campanhas</p>
              <p class="text-3xl font-bold text-blue-600 mt-1">-</p>
            </div>
            <button id="btn-nova-campanha" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all flex items-center space-x-2 shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              <span>Nova Campanha</span>
            </button>
          </div>
        </div>
      </div>

      <div id="loading" class="flex items-center justify-center py-12">
        <div class="text-center">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
          <p class="mt-4 text-gray-600">Carregando campanhas...</p>
        </div>
      </div>

      <div id="campaigns-list" class="hidden bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ID</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Nome da Campanha</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Data de Criação</th>
              </tr>
            </thead>
            <tbody id="campaigns-tbody" class="bg-white divide-y divide-gray-200">
              <!-- Campanhas serão inseridas aqui -->
            </tbody>
          </table>
        </div>
      </div>

      <div id="empty" class="hidden bg-white rounded-xl shadow-lg p-12 text-center border border-gray-200">
        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
        </svg>
        <p class="text-xml text-gray-500 font-medium">Nenhuma campanha encontrada</p>
        <p class="text-gray-400 mt-2">Comece criando sua primeira campanha</p>
      </div>

      <!-- Modal Wizard - Nova Campanha -->
      <div id="modal-wizard-campanha" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <!-- Header -->
          <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
            <h2 class="text-xl font-bold text-white">Criar Nova Campanha</h2>
            <button id="btn-fechar-wizard" class="text-white hover:text-gray-200 transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <!-- Abas/Steps -->
          <div class="border-b border-gray-200">
            <div class="flex overflow-x-auto px-6">
              <button class="wizard-tab active py-4 px-4 border-b-2 border-blue-600 text-blue-600 font-semibold flex items-center space-x-2" data-step="1">
                <span class="bg-blue-600 text-white px-2 py-1 rounded-full text-xs font-bold">1</span>
                <span class="hidden sm:inline">Lista</span>
              </button>
              <button class="wizard-tab py-4 px-4 border-b-2 border-transparent text-gray-500 font-semibold flex items-center space-x-2" data-step="2">
                <span class="bg-gray-300 text-white px-2 py-1 rounded-full text-xs font-bold">2</span>
                <span class="hidden sm:inline">Segmento</span>
              </button>
              <button class="wizard-tab py-4 px-4 border-b-2 border-transparent text-gray-500 font-semibold flex items-center space-x-2" data-step="3">
                <span class="bg-gray-300 text-white px-2 py-1 rounded-full text-xs font-bold">3</span>
                <span class="hidden sm:inline">Contatos</span>
              </button>
              <button class="wizard-tab py-4 px-4 border-b-2 border-transparent text-gray-500 font-semibold flex items-center space-x-2" data-step="4">
                <span class="bg-gray-300 text-white px-2 py-1 rounded-full text-xs font-bold">4</span>
                <span class="hidden sm:inline">Campos</span>
              </button>
              <button class="wizard-tab py-4 px-4 border-b-2 border-transparent text-gray-500 font-semibold flex items-center space-x-2" data-step="5">
                <span class="bg-gray-300 text-white px-2 py-1 rounded-full text-xs font-bold">5</span>
                <span class="hidden sm:inline">Campanha</span>
              </button>
            </div>
          </div>

          <!-- Conteúdo do Wizard -->
          <div class="p-6 space-y-4">
            <!-- Step 1: Selecionar Lista -->
            <div id="step-1" class="wizard-step block space-y-4">
              <h3 class="font-semibold text-gray-800">Selecione uma Lista</h3>
              <p class="text-sm text-gray-600">Escolha a lista de contatos para a campanha</p>
              <select id="select-list-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">Carregando listas...</option>
              </select>
            </div>

            <!-- Step 2: Escolher Segmento -->
            <div id="step-2" class="wizard-step hidden space-y-4">
              <h3 class="font-semibold text-gray-800">Selecione ou Crie um Segmento</h3>
              <p class="text-sm text-gray-600">Escolha um segmento existente ou crie um novo</p>
              
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Segmento Existente</label>
                  <select id="select-segment-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">-- Carregar segmentos existentes --</option>
                  </select>
                </div>

                <div class="border-t pt-4">
                  <label class="flex items-center space-x-2">
                    <input type="checkbox" id="check-new-segment" class="w-4 h-4">
                    <span class="text-sm font-semibold text-gray-700">Criar novo segmento</span>
                  </label>
                </div>

                <div id="new-segment-section" class="hidden border border-blue-200 bg-blue-50 rounded-lg p-4 space-y-3">
                  <input type="text" id="input-segment-name" placeholder="Nome do segmento" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                  <textarea id="textarea-segment-description" placeholder="Descrição (opcional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg h-16 resize-none"></textarea>
                </div>
              </div>
            </div>

            <!-- Step 3: Importar Contatos (apenas se novo segmento) -->
            <div id="step-3" class="wizard-step hidden space-y-4">
              <h3 class="font-semibold text-gray-800">Importar Contatos</h3>
              <p class="text-sm text-gray-600">Importe contatos para o novo segmento</p>
              
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition">
                <input type="file" id="input-import-file" accept=".csv,.xls,.xlsx" class="hidden">
                <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <p class="font-semibold text-gray-700">Selecione um arquivo CSV ou XLSX</p>
                <p class="text-xs text-gray-500 mt-1">Arrastar e soltar ou clique aqui</p>
                <button id="btn-select-file" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition">
                  Escolher Arquivo
                </button>
              </div>

              <div id="file-info" class="hidden border border-green-200 bg-green-50 rounded-lg p-4">
                <p class="text-sm text-green-800"><strong>Arquivo selecionado:</strong> <span id="file-name"></span></p>
              </div>

              <div id="sample-data-container" class="hidden">
                <h4 class="text-sm font-semibold text-gray-700 mb-2">Dados de Amostra</h4>
                <div id="sample-data-table" class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50"></div>
              </div>
            </div>

            <!-- Step 4: Mapeamento e Campos Personalizados -->
            <div id="step-4" class="wizard-step hidden space-y-4">
              <h3 class="font-semibold text-gray-800">Mapeamento de Campos e Campos Personalizados</h3>
              <p class="text-sm text-gray-600">Mapeie os campos e crie campos personalizados para o segmento</p>
              
              <div id="field-mapping-container" class="space-y-4">
                <div>
                  <h4 class="text-sm font-semibold text-gray-700 mb-2">Mapeamento de Campos</h4>
                  <div id="field-mapping" class="space-y-3 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4">
                    <p class="text-sm text-gray-500 text-center py-4">Selecione um arquivo no passo anterior</p>
                  </div>
                </div>

                <div class="border-t pt-4">
                  <h4 class="text-sm font-semibold text-gray-700 mb-2">Criei Campos Personalizados para o Segmento</h4>
                  <p class="text-xs text-gray-600 mb-3">Adicione campos que serão lidos pelo segmento</p>
                  <div id="custom-fields-list" class="space-y-2">
                    <div class="flex items-center space-x-2">
                      <input type="text" placeholder="Nome do campo" class="custom-field-input flex-1 px-3 py-2 border border-gray-300 rounded text-sm">
                      <button type="button" class="btn-remove-field px-3 py-2 text-red-600 hover:bg-red-50 rounded transition text-sm">
                        ✕
                      </button>
                    </div>
                  </div>
                  <button id="btn-add-field" class="mt-3 px-4 py-2 border border-blue-600 text-blue-600 rounded-lg text-sm font-semibold hover:bg-blue-50 transition">
                    + Adicionar Campo
                  </button>
                </div>
              </div>
            </div>

            <!-- Step 5: Configurar Campanha -->
            <div id="step-5" class="wizard-step hidden space-y-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-blue-800"><strong>Dica:</strong> Você pode clonar uma campanha existente como base</p>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Campanha existente para clonar (opcional)</label>
                <select id="select-clone-campaign" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                  <option value="">Nenhuma - Criar do zero</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Nome da Campanha *</label>
                <input type="text" id="input-campaign-name" placeholder="Ex: Promoção de Verão" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Assunto do E-mail *</label>
                <input type="text" id="input-campaign-subject" placeholder="Ex: Conheça nossa promoção" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Remetente</label>
                <input type="email" id="input-campaign-from" placeholder="Ex: noreply@seudominio.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
              </div>
            </div>
          </div>

          <!-- Botões de Navegação -->
          <div class="border-t border-gray-200 px-6 py-4 flex justify-between sticky bottom-0 bg-gray-50">
            <button id="btn-wizard-prev" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-100 transition disabled:opacity-50">
              ← Anterior
            </button>
            <button id="btn-wizard-next" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
              Próximo →
            </button>
            <button id="btn-wizard-submit" class="hidden px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition flex items-center space-x-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <span>Finalizar</span>
            </button>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Carregar navbar
      fetch('/static/navbar.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('navbar-container').innerHTML = html;
          document.getElementById('nav-campanhas')?.classList.add('bg-blue-500');
          document.getElementById('navbar-title').textContent = 'Campanhas';
        });

      function getStatusBadge(status) {
        const badges = {
          'Draft': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Rascunho</span>',
          'Sent': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Enviado</span>',
          'Scheduled': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Agendado</span>',
          'Sending': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">Enviando</span>'
        };
        return badges[status] || `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">${status || '-'}</span>`;
      }

      async function fetchCampaigns() {
        try {
          const res = await fetch('/api/campaigns/manage?action=list&RecordsPerRequest=100');
          const data = await res.json();
          document.getElementById('loading').classList.add('hidden');
          
          if (data.TotalCampaigns) {
            document.querySelector('#total-counter p:last-child').textContent = data.TotalCampaigns;
          }
          
          if (data.Campaigns && data.Campaigns.length > 0) {
            document.getElementById('campaigns-list').classList.remove('hidden');
            const tbody = document.getElementById('campaigns-tbody');
            tbody.innerHTML = '';
            data.Campaigns.forEach((c, i) => {
              tbody.innerHTML += `
                <tr class="hover:bg-blue-50 transition-colors duration-150">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${c.CampaignID || '-'}</td>
                  <td class="px-6 py-4 text-sm text-gray-900 font-semibold">${c.CampaignName || '-'}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">${getStatusBadge(c.CampaignStatus)}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${c.CreatedAt ? new Date(c.CreatedAt).toLocaleDateString('pt-BR') : '-'}</td>
                </tr>
              `;
            });
          } else {
            document.getElementById('empty').classList.remove('hidden');
          }
        } catch (e) {
          document.getElementById('loading').innerHTML = '<div class="text-center py-12"><svg class="w-16 h-16 mx-auto text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><p class="text-red-600 font-medium">Erro ao carregar campanhas</p></div>';
        }
      }
      fetchCampaigns();

      // ====== WIZARD - NOVA CAMPANHA ======
      const wizard = document.getElementById('modal-wizard-campanha');
      const btnNovaCampanha = document.getElementById('btn-nova-campanha');
      const btnFecharWizard = document.getElementById('btn-fechar-wizard');
      let currentStep = 1;
      let wizardData = { isNewSegment: false };

      btnNovaCampanha.addEventListener('click', () => {
        wizard.classList.remove('hidden');
        currentStep = 1;
        wizardData = { isNewSegment: false };
        updateWizardUI();
        carregarListas();
        carregarCampanhasParaClonar();
      });

      btnFecharWizard.addEventListener('click', () => {
        wizard.classList.add('hidden');
      });

      wizard.addEventListener('click', (e) => {
        if (e.target === wizard) wizard.classList.add('hidden');
      });

      // Tabs do Wizard
      document.querySelectorAll('.wizard-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const step = parseInt(tab.dataset.step);
          if (step < currentStep) {
            currentStep = step;
            updateWizardUI();
          }
        });
      });

      // Step 1: Selecionar Lista
      async function carregarListas() {
        try {
          const res = await fetch('/api/lists/manage?action=list&RecordsPerRequest=100');
          const data = await res.json();
          const select = document.getElementById('select-list-id');
          select.innerHTML = '<option value="">Selecione uma lista</option>';
          if (data.Lists && Array.isArray(data.Lists)) {
            data.Lists.forEach(list => {
              const option = document.createElement('option');
              option.value = list.ListID;
              option.textContent = `${list.ListName} (ID: ${list.ListID})`;
              select.appendChild(option);
            });
          }
        } catch (e) {
          console.error('Erro ao carregar listas');
        }
      }

      // Step 2: Segmentos
      document.getElementById('select-list-id').addEventListener('change', async (e) => {
        const listId = e.target.value;
        if (listId) {
          wizardData.listId = listId;
          await carregarSegmentos(listId);
        }
      });

      async function carregarSegmentos(listId) {
        try {
          const res = await fetch(`/api/segments/manage?action=list&ListID=${listId}&RecordsPerRequest=100`);
          const data = await res.json();
          const select = document.getElementById('select-segment-id');
          select.innerHTML = '<option value="">-- Nenhum (usar segmento existente) --</option>';
          if (data.Segments && Array.isArray(data.Segments)) {
            data.Segments.forEach(seg => {
              const option = document.createElement('option');
              option.value = seg.SegmentID;
              option.textContent = seg.SegmentName;
              select.appendChild(option);
            });
          }
        } catch (e) {
          console.error('Erro ao carregar segmentos');
        }
      }

      // Checkbox para novo segmento
      document.getElementById('check-new-segment').addEventListener('change', (e) => {
        wizardData.isNewSegment = e.target.checked;
        document.getElementById('new-segment-section').classList.toggle('hidden', !e.target.checked);
        document.getElementById('select-segment-id').disabled = e.target.checked;
        document.getElementById('select-segment-id').value = '';
      });

      // Seleção de arquivo para importar
      document.getElementById('btn-select-file').addEventListener('click', () => {
        document.getElementById('input-import-file').click();
      });

      document.getElementById('input-import-file').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-info').classList.remove('hidden');

        const formData = new FormData();
        formData.append('file', file);
        formData.append('listName', 'Temp Import');

        try {
          document.getElementById('field-mapping').innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><p class="text-sm text-gray-600 mt-2">Processando arquivo...</p></div>';

          const res = await fetch('/api/upload/import-list', {
            method: 'POST',
            body: formData
          });

          const data = await res.json();

          if (!data.Success) {
            alert(`Erro: ${data.error}`);
            document.getElementById('field-mapping').innerHTML = '<p class="text-sm text-red-600 text-center py-4">Erro ao processar arquivo</p>';
            return;
          }

          wizardData.file = file;
          wizardData.columns = data.Columns;
          wizardData.sampleData = data.SampleData;
          wizardData.tempId = data.TempID;

          // Exibir amostra
          if (data.SampleData && data.SampleData.length > 0) {
            const sampleTable = document.getElementById('sample-data-table');
            let html = '<table class="w-full text-xs text-left"><thead class="bg-gray-200"><tr>';
            data.Columns.forEach(col => {
              html += `<th class="px-2 py-1">${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            data.SampleData.forEach(row => {
              html += '<tr class="border-t">';
              data.Columns.forEach((col, idx) => {
                html += `<td class="px-2 py-1 truncate">${row[idx] || '-'}</td>`;
              });
              html += '</tr>';
            });
            html += '</tbody></table>';
            sampleTable.innerHTML = html;
            document.getElementById('sample-data-container').classList.remove('hidden');
          }

          renderFieldMapping(data.Columns);
        } catch (error) {
          alert(`Erro ao processar arquivo: ${error.message}`);
          document.getElementById('field-mapping').innerHTML = '<p class="text-sm text-red-600 text-center py-4">Erro ao processar arquivo</p>';
        }
      });

      function renderFieldMapping(columns) {
        const fieldMapping = document.getElementById('field-mapping');
        const standardFields = {
          'email': 'E-mail',
          'nome': 'Nome',
          'name': 'Nome',
          'telefone': 'Telefone',
          'phone': 'Telefone',
          'cpf': 'CPF'
        };

        let html = '<div class="space-y-3">';
        columns.forEach(col => {
          let suggestedField = '';
          for (const [key, label] of Object.entries(standardFields)) {
            if (col.toLowerCase().includes(key)) {
              suggestedField = label;
              break;
            }
          }
          html += `
            <div class="flex items-center space-x-2">
              <label class="w-32 text-sm font-medium text-gray-700 truncate" title="${col}">${col}:</label>
              <input type="text" 
                class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm field-mapping"
                placeholder="Ex: E-mail, Nome, Telefone..."
                value="${suggestedField}"
                data-original="${col}">
            </div>
          `;
        });
        html += '</div>';
        fieldMapping.innerHTML = html;
      }

      // Adicionar/Remover campos personalizados
      document.getElementById('btn-add-field').addEventListener('click', () => {
        const container = document.getElementById('custom-fields-list');
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-2';
        div.innerHTML = `
          <input type="text" placeholder="Nome do campo" class="custom-field-input flex-1 px-3 py-2 border border-gray-300 rounded text-sm">
          <button type="button" class="btn-remove-field px-3 py-2 text-red-600 hover:bg-red-50 rounded transition text-sm">
            ✕
          </button>
        `;
        container.appendChild(div);
        div.querySelector('.btn-remove-field').addEventListener('click', () => div.remove());
      });

      document.getElementById('custom-fields-list').addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-remove-field')) {
          e.target.closest('div').remove();
        }
      });

      // Carregar campanhas para clonar
      async function carregarCampanhasParaClonar() {
        try {
          const res = await fetch('/api/campaigns/manage?action=list&RecordsPerRequest=100');
          const data = await res.json();
          const select = document.getElementById('select-clone-campaign');
          if (data.Campaigns && Array.isArray(data.Campaigns)) {
            data.Campaigns.forEach(campaign => {
              const option = document.createElement('option');
              option.value = campaign.CampaignID;
              option.textContent = `${campaign.CampaignName} (ID: ${campaign.CampaignID})`;
              select.appendChild(option);
            });
          }
        } catch (e) {
          console.log('Erro ao carregar campanhas para clonar');
        }
      }

      // Botões de Navegação
      document.getElementById('btn-wizard-prev').addEventListener('click', () => {
        if (currentStep > 1) {
          currentStep--;
          updateWizardUI();
        }
      });

      document.getElementById('btn-wizard-next').addEventListener('click', () => {
        if (validarStep(currentStep)) {
          currentStep++;
          updateWizardUI();
        }
      });

      document.getElementById('btn-wizard-submit').addEventListener('click', async () => {
        if (validarStep(5)) {
          await criarCampanhaCompleta();
        }
      });

      function updateWizardUI() {
        // Determinar steps visíveis
        const isNewSegment = wizardData.isNewSegment;
        const stepsToShow = [1, 2];
        if (isNewSegment) stepsToShow.push(3, 4);
        stepsToShow.push(isNewSegment ? 5 : 3);

        // Atualizar visibilidade dos steps
        document.querySelectorAll('.wizard-step').forEach((step, idx) => {
          const stepNum = idx + 1;
          step.classList.toggle('hidden', !stepsToShow.includes(stepNum));
        });

        // Atualizar tabs
        document.querySelectorAll('.wizard-tab').forEach(tab => {
          const step = parseInt(tab.dataset.step);
          const isVisible = stepsToShow.includes(step);
          tab.classList.toggle('hidden', !isVisible);
          
          if (isVisible) {
            const isActive = step === currentStep;
            const isPassed = stepsToShow.indexOf(step) < stepsToShow.indexOf(currentStep);
            
            tab.classList.toggle('active', isActive);
            tab.classList.toggle('text-blue-600', isActive);
            tab.classList.toggle('text-gray-500', !isActive && !isPassed);

            const badge = tab.querySelector('span:first-child');
            if (isPassed) {
              badge.classList.add('bg-green-600');
              badge.classList.remove('bg-blue-600', 'bg-gray-300');
            } else if (isActive) {
              badge.classList.add('bg-blue-600');
              badge.classList.remove('bg-green-600', 'bg-gray-300');
            }
          }
        });

        // Atualizar botões
        document.getElementById('btn-wizard-prev').disabled = currentStep === 1;
        const finalStep = wizardData.isNewSegment ? 5 : 3;
        document.getElementById('btn-wizard-next').classList.toggle('hidden', currentStep > finalStep - 1);
        document.getElementById('btn-wizard-submit').classList.toggle('hidden', currentStep !== finalStep);
      }

      function validarStep(step) {
        if (step === 1) {
          if (!document.getElementById('select-list-id').value) {
            alert('Selecione uma lista');
            return false;
          }
          return true;
        }
        if (step === 2) {
          const isNew = document.getElementById('check-new-segment').checked;
          if (isNew) {
            const segName = document.getElementById('input-segment-name').value.trim();
            if (!segName) {
              alert('Insira um nome para o segmento');
              return false;
            }
            wizardData.segmentName = segName;
            wizardData.segmentDescription = document.getElementById('textarea-segment-description').value.trim();
          } else {
            const segId = document.getElementById('select-segment-id').value;
            if (!segId && !isNew) {
              alert('Selecione um segmento ou crie um novo');
              return false;
            }
            wizardData.segmentId = segId;
          }
          return true;
        }
        if (step === 3 && wizardData.isNewSegment) {
          if (!wizardData.file) {
            alert('Selecione um arquivo');
            return false;
          }
          // Validar mapeamento
          const mappings = document.querySelectorAll('.field-mapping');
          wizardData.fieldMappings = {};
          let hasEmailMapping = false;
          
          mappings.forEach(input => {
            const original = input.dataset.original;
            const mapped = input.value.trim();
            if (mapped) {
              wizardData.fieldMappings[original] = mapped;
              if (mapped.toLowerCase() === 'e-mail' || mapped.toLowerCase() === 'email') {
                hasEmailMapping = true;
              }
            }
          });

          if (!hasEmailMapping) {
            alert('É obrigatório mapear E-mail');
            return false;
          }
          return true;
        }
        if (step === 4 && wizardData.isNewSegment) {
          // Coletar campos personalizados
          const customFields = [];
          document.querySelectorAll('.custom-field-input').forEach(input => {
            const value = input.value.trim();
            if (value) customFields.push(value);
          });
          wizardData.customFields = customFields;
          return true;
        }
        const finalStep = wizardData.isNewSegment ? 5 : 3;
        if (step === finalStep) {
          const name = document.getElementById('input-campaign-name').value.trim();
          const subject = document.getElementById('input-campaign-subject').value.trim();
          if (!name || !subject) {
            alert('Preencha nome da campanha e assunto');
            return false;
          }
          wizardData.campaignName = name;
          wizardData.campaignSubject = subject;
          wizardData.campaignFrom = document.getElementById('input-campaign-from').value.trim();
          wizardData.cloneCampaignId = document.getElementById('select-clone-campaign').value || null;
          return true;
        }
        return true;
      }

      async function criarCampanhaCompleta() {
        try {
          const btnSubmit = document.getElementById('btn-wizard-submit');
          btnSubmit.disabled = true;
          btnSubmit.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle></svg><span>Criando...</span>';

          const payload = {
            action: 'create',
            CampaignName: wizardData.campaignName,
            Subject: wizardData.campaignSubject,
            ListID: wizardData.listId
          };

          if (wizardData.campaignFrom) payload.FromEmail = wizardData.campaignFrom;
          
          if (wizardData.isNewSegment) {
            payload.SegmentName = wizardData.segmentName;
            payload.SegmentDescription = wizardData.segmentDescription;
            payload.FieldMappings = wizardData.fieldMappings;
            payload.CustomFields = wizardData.customFields;
            payload.TempID = wizardData.tempId;
          } else {
            payload.SegmentID = wizardData.segmentId;
          }

          if (wizardData.cloneCampaignId) payload.CloneCampaignID = wizardData.cloneCampaignId;

          const res = await fetch('/api/campaigns/manage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const result = await res.json();

          if (res.ok && (result.Success === true || result.Success === 'true' || result.CampaignID)) {
            alert('✅ Campanha criada com sucesso!');
            wizard.classList.add('hidden');
            fetchCampaigns();
            wizardData = { isNewSegment: false };
            currentStep = 1;
          } else {
            const errorMsg = result.ErrorText || result.error || 'Falha ao criar campanha';
            alert(`❌ Erro: ${errorMsg}`);
            console.error('Response:', result);
          }
        } catch (error) {
          alert(`❌ Erro: ${error.message}`);
          console.error('Error:', error);
        } finally {
          const btnSubmit = document.getElementById('btn-wizard-submit');
          btnSubmit.disabled = false;
          btnSubmit.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>Finalizar</span>';
        }
      }

      // Modal Wizard - Nova Campanha
      const wizard = document.getElementById('modal-wizard-campanha');
      const btnNovaCampanha = document.getElementById('btn-nova-campanha');
      const btnFecharWizard = document.getElementById('btn-fechar-wizard');
      let currentStep = 1;
      let wizardData = {};

      btnNovaCampanha.addEventListener('click', () => {
        wizard.classList.remove('hidden');
        currentStep = 1;
        wizardData = {};
        updateWizardUI();
        carregarListasExistentes();
        carregarCampanhasParaClonar();
      });

      btnFecharWizard.addEventListener('click', () => {
        wizard.classList.add('hidden');
      });

      wizard.addEventListener('click', (e) => {
        if (e.target === wizard) wizard.classList.add('hidden');
      });

      // Tabs do Wizard
      document.querySelectorAll('.wizard-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const step = parseInt(tab.dataset.step);
          if (step < currentStep) {
            currentStep = step;
            updateWizardUI();
          }
        });
      });

      // Botões de Navegação
      document.getElementById('btn-wizard-prev').addEventListener('click', () => {
        if (currentStep > 1) {
          currentStep--;
          updateWizardUI();
        }
      });

      document.getElementById('btn-wizard-next').addEventListener('click', () => {
        if (validarStep(currentStep)) {
          if (currentStep < 3) {
            currentStep++;
            updateWizardUI();
          }
        }
      });

      document.getElementById('btn-wizard-submit').addEventListener('click', async () => {
        if (validarStep(3)) {
          await criarCampanhaCompleta();
        }
      });

      // Radio buttons para seleção de base
      document.querySelectorAll('input[name="base-type"]').forEach(radio => {
        radio.addEventListener('change', () => {
          const isNova = radio.value === 'nova';
          document.getElementById('import-section').classList.toggle('hidden', !isNova);
          document.getElementById('existing-section').classList.toggle('hidden', isNova);
          
          // Limpar mapeamento ao mudar opção
          if (isNova) {
            document.getElementById('field-mapping').innerHTML = '<p class="text-sm text-gray-500 text-center py-8">Selecione um arquivo no passo anterior para ver os campos</p>';
          } else {
            document.getElementById('field-mapping').innerHTML = '<p class="text-sm text-gray-500 text-center py-8">Nenhum mapeamento necessário para lista existente</p>';
          }
          document.getElementById('sample-data-container').classList.add('hidden');
          
          // Atualizar visibilidade do segmento
          document.getElementById('input-segment-name').parentElement.classList.toggle('hidden', !isNova);
          document.getElementById('input-segment-name').parentElement.parentElement.classList.toggle('opacity-50', !isNova);
        });
      });

      // Upload de arquivo - processar imediatamente
      document.getElementById('input-import-file').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const listName = document.getElementById('input-list-name').value.trim();
        if (!listName) {
          alert('Insira um nome para a lista antes de selecionar o arquivo');
          return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('listName', listName);
        
        try {
          document.getElementById('field-mapping').innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><p class="text-sm text-gray-600 mt-2">Processando arquivo...</p></div>';
          
          const res = await fetch('/api/upload/import-list', {
            method: 'POST',
            body: formData
          });
          
          const data = await res.json();
          
          if (!data.Success) {
            alert(`Erro: ${data.error}`);
            document.getElementById('field-mapping').innerHTML = '<p class="text-sm text-red-600 text-center py-4">Erro ao processar arquivo</p>';
            return;
          }
          
          // Guardar dados do arquivo
          wizardData.tempId = data.TempID;
          wizardData.columns = data.Columns;
          wizardData.sampleData = data.SampleData;
          
          // Exibir amostra
          if (data.SampleData && data.SampleData.length > 0) {
            const sampleTable = document.getElementById('sample-data-table');
            let html = '<table class="w-full text-xs text-left"><thead class="bg-gray-200"><tr>';
            data.Columns.forEach(col => {
              html += `<th class="px-2 py-1">${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            data.SampleData.forEach(row => {
              html += '<tr class="border-t">';
              data.Columns.forEach((col, idx) => {
                html += `<td class="px-2 py-1 truncate">${row[idx] || '-'}</td>`;
              });
              html += '</tr>';
            });
            html += '</tbody></table>';
            sampleTable.innerHTML = html;
            document.getElementById('sample-data-container').classList.remove('hidden');
          }
          
          // Renderizar mapeamento de campos
          renderFieldMapping(data.Columns);
          
        } catch (error) {
          alert(`Erro ao processar arquivo: ${error.message}`);
          document.getElementById('field-mapping').innerHTML = '<p class="text-sm text-red-600 text-center py-4">Erro ao processar arquivo</p>';
        }
      });

      // Renderizar mapeamento de campos
      function renderFieldMapping(columns) {
        const fieldMapping = document.getElementById('field-mapping');
        const standardFields = ['email', 'nome', 'name', 'telefone', 'phone', 'cpf', 'data_nascimento', 'birthdate', 'empresa', 'company', 'cargo', 'position'];
        
        let html = '<div class="space-y-3">';
        columns.forEach(col => {
          const suggestedField = standardFields.find(f => col.toLowerCase().includes(f)) || '';
          html += `
            <div class="flex items-center space-x-2">
              <label class="w-32 text-sm font-medium text-gray-700 truncate" title="${col}">${col}:</label>
              <input type="text" 
                class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm field-mapping"
                placeholder="Ex: email, nome, telefone..."
                value="${suggestedField}"
                data-original="${col}">
            </div>
          `;
        });
        html += '</div>';
        fieldMapping.innerHTML = html;
      }


      function updateWizardUI() {
        // Atualizar abas
        document.querySelectorAll('.wizard-tab').forEach((tab, idx) => {
          const step = parseInt(tab.dataset.step);
          const isActive = step === currentStep;
          const isPassed = step < currentStep;
          
          tab.classList.toggle('active', isActive);
          tab.classList.toggle('text-blue-600', isActive);
          tab.classList.toggle('text-gray-500', !isActive && !isPassed);
          
          const badge = tab.querySelector('span:first-child');
          if (isPassed) {
            badge.classList.add('bg-green-600');
            badge.classList.remove('bg-blue-600', 'bg-gray-300');
          } else if (isActive) {
            badge.classList.add('bg-blue-600');
            badge.classList.remove('bg-green-600', 'bg-gray-300');
          }
          
          const border = isActive ? 'border-blue-600' : isPassed ? 'border-green-600' : 'border-transparent';
          tab.className = tab.className.replace(/border-\w+-600|border-transparent/g, border) + ' ' + border;
        });

        // Mostrar/ocultar steps
        document.querySelectorAll('.wizard-step').forEach((step, idx) => {
          step.classList.toggle('hidden', idx + 1 !== currentStep);
        });

        // Atualizar botões
        document.getElementById('btn-wizard-prev').disabled = currentStep === 1;
        document.getElementById('btn-wizard-next').classList.toggle('hidden', currentStep === 3);
        document.getElementById('btn-wizard-submit').classList.toggle('hidden', currentStep !== 3);
      }

      function validarStep(step) {
        if (step === 1) {
          const baseType = document.querySelector('input[name="base-type"]:checked')?.value;
          if (baseType === 'nova') {
            const file = document.getElementById('input-import-file').files[0];
            const listName = document.getElementById('input-list-name').value.trim();
            if (!file || !listName) {
              alert('Selecione um arquivo e insira um nome para a lista');
              return false;
            }
            wizardData.file = file;
            wizardData.listName = listName;
          } else {
            const listId = document.getElementById('select-list-id').value;
            if (!listId) {
              alert('Selecione uma lista');
              return false;
            }
            wizardData.listId = listId;
          }
          wizardData.baseType = baseType;
          return true;
        }
        if (step === 2) {
          if (wizardData.baseType === 'nova') {
            // Validar mapeamento - obrigatório para lista nova
            const mappings = document.querySelectorAll('.field-mapping');
            wizardData.fieldMappings = {};
            let hasMapping = false;
            
            mappings.forEach(input => {
              const original = input.dataset.original;
              const mapped = input.value.trim();
              if (mapped) {
                wizardData.fieldMappings[original] = mapped;
                hasMapping = true;
              }
            });
            
            if (!hasMapping) {
              alert('Mapeie pelo menos um campo');
              return false;
            }

            // Validar segmento
            const segmentName = document.getElementById('input-segment-name').value.trim();
            if (!segmentName) {
              alert('Insira um nome para o segmento');
              return false;
            }
            wizardData.segmentName = segmentName;
            wizardData.segmentDescription = document.getElementById('textarea-segment-description').value.trim();
          } else {
            // Para lista existente, step 2 é opcional
            wizardData.segmentName = '';
            wizardData.segmentDescription = '';
          }
          return true;
        }
        if (step === 3) {
          const campaignName = document.getElementById('input-campaign-name').value.trim();
          const subject = document.getElementById('input-campaign-subject').value.trim();
          if (!campaignName || !subject) {
            alert('Preencha o nome da campanha e o assunto');
            return false;
          }
          wizardData.campaignName = campaignName;
          wizardData.subject = subject;
          wizardData.fromEmail = document.getElementById('input-campaign-from').value.trim();
          wizardData.cloneCampaignId = document.getElementById('select-clone-campaign').value || null;
          return true;
        }
        return true;
      }

      async function carregarListasExistentes() {
        try {
          const res = await fetch('/api/lists/manage?action=list&RecordsPerRequest=100');
          const data = await res.json();
          const select = document.getElementById('select-list-id');
          select.innerHTML = '<option value="">Selecione uma lista</option>';
          if (data.Lists && Array.isArray(data.Lists)) {
            data.Lists.forEach(list => {
              const option = document.createElement('option');
              option.value = list.ListID;
              option.textContent = `${list.ListName} (ID: ${list.ListID})`;
              select.appendChild(option);
            });
          }
        } catch (e) {
          alert('Erro ao carregar listas');
        }
      }

      async function carregarCampanhasParaClonar() {
        try {
          const res = await fetch('/api/campaigns/manage?action=list&RecordsPerRequest=100');
          const data = await res.json();
          const select = document.getElementById('select-clone-campaign');
          if (data.Campaigns && Array.isArray(data.Campaigns)) {
            data.Campaigns.forEach(campaign => {
              const option = document.createElement('option');
              option.value = campaign.CampaignID;
              option.textContent = `${campaign.CampaignName} (ID: ${campaign.CampaignID})`;
              select.appendChild(option);
            });
          }
        } catch (e) {
          console.log('Erro ao carregar campanhas para clonar');
        }
      }

      async function criarCampanhaCompleta() {
        try {
          const btnSubmit = document.getElementById('btn-wizard-submit');
          btnSubmit.disabled = true;
          btnSubmit.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Criando...</span>';

          let endpoint = '/api/campaigns/manage';
          let payload = {};

          // Se for clonagem
          if (wizardData.cloneCampaignId) {
            endpoint = '/api/campaigns/clone';
            payload = {
              CloneCampaignID: wizardData.cloneCampaignId,
              CampaignName: wizardData.campaignName,
              Subject: wizardData.subject
            };
            
            // Se também usar lista nova, precisamos criar a lista e passar seu ID
            if (wizardData.baseType === 'nova') {
              payload.ListID = wizardData.listId; // Será obtido na resposta do upload
            } else {
              payload.ListID = wizardData.listId;
            }
          } else {
            // Criação normal
            endpoint = '/api/campaigns/manage';
            payload = {
              action: 'create',
              CampaignName: wizardData.campaignName,
              Subject: wizardData.subject
            };

            if (wizardData.baseType === 'nova') {
              payload.ListName = wizardData.listName;
              payload.SegmentName = wizardData.segmentName;
              payload.SegmentDescription = wizardData.segmentDescription;
              payload.FieldMappings = wizardData.fieldMappings;
              payload.TempID = wizardData.tempId;
            } else {
              payload.ListID = wizardData.listId;
            }
          }

          if (wizardData.fromEmail) payload.FromEmail = wizardData.fromEmail;

          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const result = await res.json();

          if (res.ok && (result.Success === true || result.Success === 'true' || result.CampaignID)) {
            alert('✅ Campanha criada com sucesso!');
            wizard.classList.add('hidden');
            fetchCampaigns();
            // Limpar dados do wizard
            wizardData = {};
            currentStep = 1;
          } else {
            const errorMsg = result.ErrorText || result.error || 'Falha ao criar campanha';
            alert(`❌ Erro: ${errorMsg}`);
            console.error('Response:', result);
          }
        } catch (error) {
          alert(`❌ Erro: ${error.message}`);
          console.error('Error:', error);
        } finally {
          const btnSubmit = document.getElementById('btn-wizard-submit');
          btnSubmit.disabled = false;
          btnSubmit.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>Finalizar</span>';
        }
      }
    </script>
  </body>
</html>
