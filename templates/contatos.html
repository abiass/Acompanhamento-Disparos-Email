<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contatos - Flowbiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  </head>
  <body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Navbar -->
    <div id="navbar-container"></div>

    <!-- Conteúdo -->
    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
              <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
              Contatos
            </h1>
            <p class="mt-2 text-gray-600">Gerencie seus assinantes e leads</p>
          </div>
          <div class="flex items-center space-x-4">
            <div id="total-counter" class="bg-white rounded-lg shadow-sm px-6 py-4 border border-gray-200">
              <p class="text-sm text-gray-500 font-medium">Total de Contatos</p>
              <p class="text-3xl font-bold text-blue-600 mt-1">-</p>
            </div>
            <button id="btn-importar-contatos" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all flex items-center space-x-2 shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
              </svg>
              <span>Importar Contatos</span>
            </button>
          </div>
        </div>
      </div>

      <div id="loading" class="flex items-center justify-center py-12">
        <div class="text-center">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
          <p class="mt-4 text-gray-600">Carregando contatos...</p>
        </div>
      </div>

      <div id="contatos-list" class="hidden bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ID</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">E-mail</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Nome</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Data de Cadastro</th>
              </tr>
            </thead>
            <tbody id="contatos-tbody" class="bg-white divide-y divide-gray-200">
              <!-- Contatos serão inseridos aqui -->
            </tbody>
          </table>
        </div>
      </div>

      <div id="empty" class="hidden bg-white rounded-xl shadow-lg p-12 text-center border border-gray-200">
        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
        </svg>
        <p class="text-xl text-gray-500 font-medium">Nenhum contato encontrado</p>
        <p class="text-gray-400 mt-2">Comece adicionando seus primeiros contatos</p>
      </div>

      <!-- Modal Wizard - Importar Contatos -->
      <div id="modal-wizard-importar" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <!-- Header -->
          <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
            <h2 class="text-xl font-bold text-white">Importar Contatos</h2>
            <button id="btn-fechar-wizard" class="text-white hover:text-gray-200 transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <!-- Abas/Steps -->
          <div class="border-b border-gray-200">
            <div class="flex overflow-x-auto px-6">
              <button class="wizard-tab active py-4 px-4 border-b-2 border-blue-600 text-blue-600 font-semibold flex items-center space-x-2" data-step="1">
                <span class="bg-blue-600 text-white px-2 py-1 rounded-full text-xs font-bold">1</span>
                <span class="hidden sm:inline">Arquivo</span>
              </button>
              <button class="wizard-tab py-4 px-4 border-b-2 border-transparent text-gray-500 font-semibold flex items-center space-x-2" data-step="2">
                <span class="bg-gray-300 text-white px-2 py-1 rounded-full text-xs font-bold">2</span>
                <span class="hidden sm:inline">Mapeamento</span>
              </button>
              <button class="wizard-tab py-4 px-4 border-b-2 border-transparent text-gray-500 font-semibold flex items-center space-x-2" data-step="3">
                <span class="bg-gray-300 text-white px-2 py-1 rounded-full text-xs font-bold">3</span>
                <span class="hidden sm:inline">Confirmação</span>
              </button>
            </div>
          </div>

          <!-- Conteúdo do Wizard -->
          <div class="p-6 space-y-4">
            <!-- Step 1: Selecionar Arquivo -->
            <div id="step-1" class="wizard-step block space-y-4">
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition">
                <input type="file" id="input-import-file" accept=".csv,.xls,.xlsx" class="hidden">
                <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <p class="font-semibold text-gray-700">Selecione um arquivo CSV ou XLSX</p>
                <p class="text-xs text-gray-500 mt-1">Arrastar e soltar ou clique aqui</p>
                <button id="btn-select-file" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition">
                  Escolher Arquivo
                </button>
              </div>

              <div class="border-t pt-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Nome da Lista (opcional)</label>
                <input type="text" id="input-list-name" placeholder="Ex: Lista de Clientes" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>

              <div id="file-info" class="hidden border border-green-200 bg-green-50 rounded-lg p-4">
                <p class="text-sm text-green-800"><strong>Arquivo selecionado:</strong> <span id="file-name"></span></p>
              </div>
            </div>

            <!-- Step 2: Mapear Campos -->
            <div id="step-2" class="wizard-step hidden space-y-4">
              <h3 class="font-semibold text-gray-800">Mapeamento de Campos</h3>
              <p class="text-sm text-gray-600">Mapeie os campos do arquivo com os campos padrão</p>
              
              <!-- Dados de amostra -->
              <div id="sample-data-container" class="hidden">
                <h4 class="text-sm font-semibold text-gray-700 mb-2">Dados de Amostra</h4>
                <div id="sample-data-table" class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50"></div>
              </div>

              <div id="field-mapping" class="space-y-3 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4">
                <p class="text-sm text-gray-500 text-center py-8">Selecione um arquivo no passo anterior para ver os campos</p>
              </div>
            </div>

            <!-- Step 3: Confirmação -->
            <div id="step-3" class="wizard-step hidden space-y-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-sm text-blue-800"><strong>Resumo da importação:</strong></p>
                <ul class="mt-3 space-y-2 text-sm text-blue-800">
                  <li><strong>Arquivo:</strong> <span id="summary-file">-</span></li>
                  <li><strong>Campos mapeados:</strong> <span id="summary-fields">0</span></li>
                  <li><strong>Lista:</strong> <span id="summary-list">-</span></li>
                </ul>
              </div>
              <p class="text-sm text-gray-600">Clique em "Finalizar" para importar os contatos. Você receberá uma notificação quando a importação for concluída.</p>
            </div>
          </div>

          <!-- Botões de Navegação -->
          <div class="border-t border-gray-200 px-6 py-4 flex justify-between sticky bottom-0 bg-gray-50">
            <button id="btn-wizard-prev" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-100 transition disabled:opacity-50">
              ← Anterior
            </button>
            <button id="btn-wizard-next" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
              Próximo →
            </button>
            <button id="btn-wizard-submit" class="hidden px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition flex items-center space-x-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <span>Finalizar</span>
            </button>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Carregar navbar
      fetch('/static/navbar.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('navbar-container').innerHTML = html;
          document.getElementById('nav-contatos')?.classList.add('bg-blue-500');
          document.getElementById('navbar-title').textContent = 'Contatos';
        });

      // ====== WIZARD DE IMPORTAÇÃO ======
      const wizard = document.getElementById('modal-wizard-importar');
      const btnImportarContatos = document.getElementById('btn-importar-contatos');
      const btnFecharWizard = document.getElementById('btn-fechar-wizard');
      let currentStep = 1;
      let wizardData = {};

      btnImportarContatos.addEventListener('click', () => {
        wizard.classList.remove('hidden');
        currentStep = 1;
        wizardData = {};
        updateWizardUI();
      });

      btnFecharWizard.addEventListener('click', () => {
        wizard.classList.add('hidden');
      });

      wizard.addEventListener('click', (e) => {
        if (e.target === wizard) wizard.classList.add('hidden');
      });

      // Tabs do Wizard
      document.querySelectorAll('.wizard-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const step = parseInt(tab.dataset.step);
          if (step < currentStep) {
            currentStep = step;
            updateWizardUI();
          }
        });
      });

      // Seleção de arquivo
      document.getElementById('btn-select-file').addEventListener('click', () => {
        document.getElementById('input-import-file').click();
      });

      document.getElementById('input-import-file').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const listName = document.getElementById('input-list-name').value.trim() || file.name.replace(/\.[^/.]+$/, "");
        
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-info').classList.remove('hidden');

        const formData = new FormData();
        formData.append('file', file);
        formData.append('listName', listName);

        try {
          document.getElementById('field-mapping').innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div><p class="text-sm text-gray-600 mt-2">Processando arquivo...</p></div>';

          const res = await fetch('/api/upload/import-list', {
            method: 'POST',
            body: formData
          });

          const data = await res.json();

          if (!data.Success) {
            alert(`Erro: ${data.error}`);
            document.getElementById('field-mapping').innerHTML = '<p class="text-sm text-red-600 text-center py-4">Erro ao processar arquivo</p>';
            return;
          }

          wizardData.file = file;
          wizardData.listName = listName;
          wizardData.tempId = data.TempID;
          wizardData.columns = data.Columns;
          wizardData.sampleData = data.SampleData;

          // Exibir amostra
          if (data.SampleData && data.SampleData.length > 0) {
            const sampleTable = document.getElementById('sample-data-table');
            let html = '<table class="w-full text-xs text-left"><thead class="bg-gray-200"><tr>';
            data.Columns.forEach(col => {
              html += `<th class="px-2 py-1">${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            data.SampleData.forEach(row => {
              html += '<tr class="border-t">';
              data.Columns.forEach((col, idx) => {
                html += `<td class="px-2 py-1 truncate">${row[idx] || '-'}</td>`;
              });
              html += '</tr>';
            });
            html += '</tbody></table>';
            sampleTable.innerHTML = html;
            document.getElementById('sample-data-container').classList.remove('hidden');
          }

          renderFieldMapping(data.Columns);
        } catch (error) {
          alert(`Erro ao processar arquivo: ${error.message}`);
          document.getElementById('field-mapping').innerHTML = '<p class="text-sm text-red-600 text-center py-4">Erro ao processar arquivo</p>';
        }
      });

      // Renderizar mapeamento de campos
      function renderFieldMapping(columns) {
        const fieldMapping = document.getElementById('field-mapping');
        const standardFields = {
          'email': 'E-mail',
          'nome': 'Nome',
          'name': 'Nome',
          'telefone': 'Telefone',
          'phone': 'Telefone',
          'cpf': 'CPF',
          'data_nascimento': 'Data de Nascimento',
          'birthdate': 'Data de Nascimento',
          'empresa': 'Empresa',
          'company': 'Empresa',
          'cargo': 'Cargo',
          'position': 'Cargo'
        };

        let html = '<div class="space-y-3">';
        columns.forEach(col => {
          let suggestedField = '';
          for (const [key, label] of Object.entries(standardFields)) {
            if (col.toLowerCase().includes(key)) {
              suggestedField = label;
              break;
            }
          }
          html += `
            <div class="flex items-center space-x-2">
              <label class="w-32 text-sm font-medium text-gray-700 truncate" title="${col}">${col}:</label>
              <input type="text" 
                class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm field-mapping"
                placeholder="Ex: E-mail, Nome, Telefone..."
                value="${suggestedField}"
                data-original="${col}">
            </div>
          `;
        });
        html += '</div>';
        fieldMapping.innerHTML = html;
      }

      // Botões de Navegação
      document.getElementById('btn-wizard-prev').addEventListener('click', () => {
        if (currentStep > 1) {
          currentStep--;
          updateWizardUI();
        }
      });

      document.getElementById('btn-wizard-next').addEventListener('click', () => {
        if (validarStep(currentStep)) {
          if (currentStep < 3) {
            currentStep++;
            updateWizardUI();
          }
        }
      });

      document.getElementById('btn-wizard-submit').addEventListener('click', async () => {
        if (validarStep(3)) {
          await importarContatos();
        }
      });

      function updateWizardUI() {
        document.querySelectorAll('.wizard-tab').forEach((tab, idx) => {
          const step = parseInt(tab.dataset.step);
          const isActive = step === currentStep;
          const isPassed = step < currentStep;

          tab.classList.toggle('active', isActive);
          tab.classList.toggle('text-blue-600', isActive);
          tab.classList.toggle('text-gray-500', !isActive && !isPassed);

          const badge = tab.querySelector('span:first-child');
          if (isPassed) {
            badge.classList.add('bg-green-600');
            badge.classList.remove('bg-blue-600', 'bg-gray-300');
          } else if (isActive) {
            badge.classList.add('bg-blue-600');
            badge.classList.remove('bg-green-600', 'bg-gray-300');
          }

          const border = isActive ? 'border-blue-600' : isPassed ? 'border-green-600' : 'border-transparent';
          tab.className = tab.className.replace(/border-\w+-600|border-transparent/g, border) + ' ' + border;
        });

        document.querySelectorAll('.wizard-step').forEach((step, idx) => {
          step.classList.toggle('hidden', idx + 1 !== currentStep);
        });

        document.getElementById('btn-wizard-prev').disabled = currentStep === 1;
        document.getElementById('btn-wizard-next').classList.toggle('hidden', currentStep === 3);
        document.getElementById('btn-wizard-submit').classList.toggle('hidden', currentStep !== 3);
      }

      function validarStep(step) {
        if (step === 1) {
          if (!wizardData.file) {
            alert('Selecione um arquivo');
            return false;
          }
          return true;
        }
        if (step === 2) {
          const mappings = document.querySelectorAll('.field-mapping');
          wizardData.fieldMappings = {};
          let hasEmailMapping = false;

          mappings.forEach(input => {
            const original = input.dataset.original;
            const mapped = input.value.trim();
            if (mapped) {
              wizardData.fieldMappings[original] = mapped;
              if (mapped.toLowerCase() === 'e-mail' || mapped.toLowerCase() === 'email') {
                hasEmailMapping = true;
              }
            }
          });

          if (!hasEmailMapping) {
            alert('É obrigatório mapear pelo menos o campo de E-mail');
            return false;
          }
          return true;
        }
        if (step === 3) {
          // Atualizar resumo
          document.getElementById('summary-file').textContent = wizardData.file?.name || '-';
          document.getElementById('summary-fields').textContent = Object.keys(wizardData.fieldMappings).length;
          document.getElementById('summary-list').textContent = wizardData.listName || 'Padrão';
          return true;
        }
        return true;
      }

      async function importarContatos() {
        try {
          const btnSubmit = document.getElementById('btn-wizard-submit');
          btnSubmit.disabled = true;
          btnSubmit.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle></svg><span>Importando...</span>';

          const payload = {
            action: 'import',
            FileName: wizardData.file.name,
            ListName: wizardData.listName,
            FieldMappings: wizardData.fieldMappings,
            TempID: wizardData.tempId
          };

          const res = await fetch('/api/contacts/manage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const result = await res.json();

          if (res.ok && (result.Success === true || result.Success === 'true')) {
            alert('✅ Contatos importados com sucesso!');
            wizard.classList.add('hidden');
            fetchContatos();
            wizardData = {};
            currentStep = 1;
          } else {
            const errorMsg = result.ErrorText || result.error || 'Falha ao importar contatos';
            alert(`❌ Erro: ${errorMsg}`);
            console.error('Response:', result);
          }
        } catch (error) {
          alert(`❌ Erro: ${error.message}`);
          console.error('Error:', error);
        } finally {
          const btnSubmit = document.getElementById('btn-wizard-submit');
          btnSubmit.disabled = false;
          btnSubmit.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>Finalizar</span>';
        }
      }

      // ====== RESTO DO CÓDIGO ======

      function getStatusBadge(status) {
        const badges = {
          'Active': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Ativo</span>',
          'Unsubscribed': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Descadastrado</span>',
          'Bounced': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">Bounce</span>',
          'Pending': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pendente</span>'
        };
        return badges[status] || `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">${status || '-'}</span>`;
      }

      async function fetchContatos() {
        try {
          const res = await fetch('/api/contacts/manage?action=list&RecordsPerRequest=100');
          const data = await res.json();
          document.getElementById('loading').classList.add('hidden');
          
          if (data.TotalSubscribers) {
            document.querySelector('#total-counter p:last-child').textContent = data.TotalSubscribers;
          }
          
          if (data.Subscribers && data.Subscribers.length > 0) {
            document.getElementById('contatos-list').classList.remove('hidden');
            const tbody = document.getElementById('contatos-tbody');
            tbody.innerHTML = '';
            data.Subscribers.forEach(c => {
              tbody.innerHTML += `
                <tr class="hover:bg-blue-50 transition-colors duration-150">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${c.SubscriberID || '-'}</td>
                  <td class="px-6 py-4 text-sm text-gray-900 font-semibold">${c.EmailAddress || '-'}</td>
                  <td class="px-6 py-4 text-sm text-gray-600">${c.Name || 'Sem nome'}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">${getStatusBadge(c.Status)}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${c.SubscribeDate ? new Date(c.SubscribeDate).toLocaleDateString('pt-BR') : '-'}</td>
                </tr>
              `;
            });
          } else {
            document.getElementById('empty').classList.remove('hidden');
          }
        } catch (e) {
          document.getElementById('loading').innerHTML = '<div class="text-center py-12"><svg class="w-16 h-16 mx-auto text-red-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><p class="text-red-600 font-medium">Erro ao carregar contatos</p></div>';
        }
      }
      fetchContatos();
    </script>
  </body>
</html>
